#!/usr/bin/env bash
set -eo pipefail

# Weasel Installer
# Downloads and installs weaselup, then runs it to install weasel

WEASEL_DIR="${WEASEL_DIR:-$HOME/.weasel}"
WEASEL_BIN_DIR="$WEASEL_DIR/bin"

REPO="slvDev/weasel"
WEASELUP_URL="https://raw.githubusercontent.com/$REPO/main/weaselup/weaselup"

main() {
    echo "Installing weaselup..."

    # Create directories
    mkdir -p "$WEASEL_BIN_DIR"

    # Download weaselup
    if command -v curl &> /dev/null; then
        curl -fsSL "$WEASELUP_URL" -o "$WEASEL_BIN_DIR/weaselup"
    elif command -v wget &> /dev/null; then
        wget -qO "$WEASEL_BIN_DIR/weaselup" "$WEASELUP_URL"
    else
        echo "Error: curl or wget is required"
        exit 1
    fi

    # Make executable
    chmod +x "$WEASEL_BIN_DIR/weaselup"

    # Add to PATH (sets PROFILE variable)
    add_to_path

    echo ""

    # Run weaselup to install weasel
    "$WEASEL_BIN_DIR/weaselup"

    # Final message with source instruction
    echo ""
    if [[ -n "$PROFILE" ]]; then
        echo "Run 'source $PROFILE' or start a new terminal to use weasel."
    fi
    echo "Run 'weaselup' anytime to update."
}

add_to_path() {
    case $SHELL in
        */zsh)
            PROFILE="${ZDOTDIR-"$HOME"}/.zshenv"
            add_to_file "$PROFILE"
            ;;
        */bash)
            if [[ -f "$HOME/.bash_profile" ]]; then
                PROFILE="$HOME/.bash_profile"
            else
                PROFILE="$HOME/.bashrc"
            fi
            add_to_file "$PROFILE"
            ;;
        */fish)
            PROFILE="$HOME/.config/fish/config.fish"
            add_to_fish
            ;;
        *)
            echo "Could not detect shell. Add $WEASEL_BIN_DIR to your PATH manually."
            ;;
    esac
}

add_to_file() {
    local file="$1"
    local line="export PATH=\"\$PATH:$WEASEL_BIN_DIR\""

    # Check if already added
    if [[ -f "$file" ]] && grep -q "$WEASEL_BIN_DIR" "$file"; then
        return
    fi

    echo "" >> "$file"
    echo "# Weasel" >> "$file"
    echo "$line" >> "$file"
}

add_to_fish() {
    local fish_config="$HOME/.config/fish/config.fish"
    mkdir -p "$(dirname "$fish_config")"

    if [[ -f "$fish_config" ]] && grep -q "$WEASEL_BIN_DIR" "$fish_config"; then
        return
    fi

    echo "" >> "$fish_config"
    echo "# Weasel" >> "$fish_config"
    echo "fish_add_path -a \"$WEASEL_BIN_DIR\"" >> "$fish_config"
}

main
